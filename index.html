<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Visited Countries Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYXNodG9uLW1vcnJvdyIsImEiOiJjbTllNGxrZG8xOXRxMmpvdm52ZWpidmw3In0.nmN1vCpni_NNgZDqChZQ0w';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      zoom: 1.5,
      center: [0, 20]
    });

    let visitedCodes = [];

    map.on('load', () => {
      map.addSource('countries', {
        type: 'vector',
        url: 'mapbox://mapbox.country-boundaries-v1'
      });

      // Base layer (unvisited)
      map.addLayer({
        id: 'country-fills',
        type: 'fill',
        source: 'countries',
        'source-layer': 'country_boundaries',
        paint: {
          'fill-color': '#9CA3AF',
          'fill-opacity': 0.5
        }
      });

      // Hover: visited countries
      map.addLayer({
        id: 'hover-visited',
        type: 'fill',
        source: 'countries',
        'source-layer': 'country_boundaries',
        paint: {
          'fill-color': '#10B981',
          'fill-opacity': 0.9
        },
        filter: ['==', 'iso_3166_1_alpha_3', '']
      });

      // Hover: unvisited countries
      map.addLayer({
        id: 'hover-unvisited',
        type: 'fill',
        source: 'countries',
        'source-layer': 'country_boundaries',
        paint: {
          'fill-color': '#F3F4F6',
          'fill-opacity': 0.8
        },
        filter: ['==', 'iso_3166_1_alpha_3', '']
      });

      // Country click redirect
      map.on('click', 'country-fills', (e) => {
        const name = e.features[0].properties.name_en.toLowerCase().replace(/\s+/g, '-');
        window.location.href = `https://mike-lee.me/countries/${name}`;
      });

      let currentHoverId = null;

      map.on('mousemove', 'country-fills', (e) => {
        if (e.features.length > 0) {
          const feature = e.features[0];
          const iso = feature.properties.iso_3166_1_alpha_3;
          currentHoverId = iso;
          const isVisited = visitedCodes.includes(iso);

          map.setFilter('hover-visited', isVisited ? ['==', 'iso_3166_1_alpha_3', iso] : ['==', 'iso_3166_1_alpha_3', '']);
          map.setFilter('hover-unvisited', !isVisited ? ['==', 'iso_3166_1_alpha_3', iso] : ['==', 'iso_3166_1_alpha_3', '']);
        }
      });

      map.on('mouseleave', 'country-fills', () => {
        map.setFilter('hover-visited', ['==', 'iso_3166_1_alpha_3', '']);
        map.setFilter('hover-unvisited', ['==', 'iso_3166_1_alpha_3', '']);
        currentHoverId = null;
      });

      // Fetch visited countries
      fetch("https://wcb-map.netlify.app/.netlify/functions/visited")
        .then(res => res.json())
        .then(data => {
          visitedCodes = data.visitedCountries;

          map.addLayer({
            id: 'visited-countries',
            type: 'fill',
            source: 'countries',
            'source-layer': 'country_boundaries',
            filter: ['in', 'iso_3166_1_alpha_3', ...visitedCodes],
            paint: {
              'fill-color': '#2563EB',
              'fill-opacity': 0.75
            }
          });
        });

      map.getCanvas().style.cursor = 'default';
    });
  </script>
</body>
</html>
